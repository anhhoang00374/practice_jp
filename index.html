<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ã”n táº­p tiáº¿ng Nháº­t â€” TrÃ¬nh cháº¡y cÃ¢u</title>
    <style>
        :root{
            --bg: #f6f9fc;
            --card: #ffffff;
            --text: #1f2937;
            --muted: #6b7280;
            --brand: #3b82f6; /* xanh giÃ¡o dá»¥c dá»‹u */
            --brand-2: #10b981; /* xanh ngá»c dá»‹u */
            --danger: #ef4444;
            --shadow: 0 8px 24px rgba(27, 51, 89, .08);
            --radius: 16px;
        }
        *{box-sizing:border-box}
        body{
            margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
            background: radial-gradient(1200px 600px at 10% -10%, #e8f1ff 0%, transparent 40%),
            radial-gradient(1200px 600px at 120% 10%, #e9fff6 0%, transparent 40%),
            var(--bg);
            color:var(--text);
        }
        header{ padding: 20px clamp(16px, 4vw, 32px); display:flex; align-items:center; gap:16px; flex-wrap:wrap; }
        h1{font-size: clamp(18px, 2.4vw, 26px); margin:0}
        header p{margin:0; color:var(--muted)}

        main{padding: 8px clamp(16px, 4vw, 32px) 32px;}

        .panel{ background:var(--card); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); }
        .grid{ display:grid; gap: 12px; }
        .grid.controls{ grid-template-columns: repeat(12, 1fr); align-items:end; }
        .control{ display:flex; flex-direction:column; gap:6px; }
        .control label{ font-size:12px; color:var(--muted) }
        .control select, .control input[type="range"], .control button{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; color:var(--text); }
        .control input[type="range"]{ padding:0; }
        .row{ display:flex; gap:8px; flex-wrap:wrap; }

        .btn{ cursor:pointer; border:0; padding:10px 14px; border-radius:12px; font-weight:600; }
        .btn-primary{ background: linear-gradient(135deg, var(--brand), var(--brand-2)); color:#fff; }
        .btn-ghost{ background: #f3f4f6; color:#111827; }

        .status{ font-size: 12px; color: var(--muted); }

        .player{ margin-top:16px; display:grid; grid-template-columns: 1fr; gap:12px; }
        .display{ min-height: 180px; display:grid; align-items:center; justify-items:center; text-align:center; padding: 24px; border-radius: var(--radius); background:#fff; box-shadow: var(--shadow); }
        .sentence{ font-size: clamp(32px, 3.4vw, 48px); line-height:1.4; }
        .meta{ margin-top:8px; font-size:12px; color:var(--muted) }

        .controls-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        .chip{ padding:6px 10px; border-radius: 999px; font-size:12px; background:#eef2ff; color:#3730a3; }

        .progress{ height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
        .progress > div{ height:100%; background: linear-gradient(90deg, var(--brand), var(--brand-2)); width:0; }

        .d-none{
            display: none;
        }
        .center{
            text-align: center;
        }
        .full-width{
            width: 100%;
        }
        @media (max-width: 980px){ .grid.controls{ grid-template-columns: 1fr 1fr; } }
        @media (min-width: 981px){ .grid.controls{ grid-template-columns: repeat(12, 1fr); } .span-3{ grid-column: span 3; } .span-2{ grid-column: span 2; } .span-4{ grid-column: span 4; }}
    </style>
    <!-- Náº¡p dá»¯ liá»‡u tÄ©nh tá»« assets/main.js -->
    <script defer src="assets/main.js"></script>
</head>
<body>
<header>
<!--    <div class="logo">JP</div>-->
    <div class="center full-width">
        <h1 >Ã”n táº­p tiáº¿ng Nháº­t</h1>
        <p class="d-none">Dá»¯ liá»‡u Ä‘á»c trá»±c tiáº¿p tá»« <code>assets/main.js</code>. Chá»n ngÃ y Â· Chá»n ngÃ´n ngá»¯ Â· Tá»± cháº¡y theo tá»‘c Ä‘á»™ Â· ÄÃ¡nh dáº¥u Ä‘Ã£ thuá»™c</p>
    </div>
</header>

<main class="grid" aria-live="polite">
    <!-- SUMMARY PANEL (khÃ´ng cÃ²n khu vá»±c náº¡p file) -->
    <section class="panel grid controls d-none" id="summaryPanel">
        <div class="control span-4">
            <label>Tá»•ng quan dá»¯ liá»‡u</label>
            <div class="chip" id="dataSummary">Äang chá» dá»¯ liá»‡u tá»« <code>assets/main.js</code>â€¦</div>
        </div>
        <div class="control span-8">
            <label>Gá»£i Ã½ cáº¥u trÃºc <code>assets/main.js</code></label>
            <div class="status">Táº¡o biáº¿n global <code>window.JP_LESSONS = [ ... ]</code> (má»™t máº£ng nhiá»u buá»•i, má»—i buá»•i cÃ³ <code>day</code>, <code>topic</code>, <code>sections.japanese[]</code> vÃ  <code>sections.vietnamese[]</code> â€” má»—i cÃ¢u cÃ³ <code>id</code>, <code>text</code>).</div>
        </div>
    </section>

    <!-- FILTER / CONTROL PANEL -->
    <section class="panel grid controls" id="controlPanel" aria-disabled="true">
        <div class="control span-2">
            <label for="startDay">Tá»« buá»•i</label>
            <select id="startDay"></select>
        </div>
        <div class="control span-2">
            <label for="endDay">Äáº¿n buá»•i</label>
            <select id="endDay"></select>
            <div class="status" id="rangeWarn" hidden>ÄÃ£ tá»± Ä‘iá»u chá»‰nh Ä‘á»ƒ "Äáº¿n buá»•i" â‰¥ "Tá»« buá»•i".</div>
        </div>
        <div class="control span-3">
            <label for="language">NgÃ´n ngá»¯ Ã´n táº­p</label>
            <select id="language">
                <option value="japanese">Tiáº¿ng Nháº­t</option>
                <option value="vietnamese">Tiáº¿ng Viá»‡t</option>
            </select>
        </div>
        <div class="control span-3">
            <label for="mode">Cháº¿ Ä‘á»™ Ã´n</label>
            <select id="mode">
                <option value="all">Táº¥t cáº£ cÃ¢u</option>
                <option value="unlearned">Chá»‰ cÃ¢u chÆ°a thuá»™c</option>
            </select>
        </div>
        <div class="control span-2">
            <label for="speed">Tá»‘c Ä‘á»™ (giÃ¢y/cÃ¢u): <span id="speedLabel">3</span>s</label>
            <input type="range" id="speed" min="1" max="10" step="0.5" value="3" />
        </div>
        <div class="control span-2">
            <label for="shuffle">Ngáº«u nhiÃªn</label>
            <select id="shuffle">
                <option value="off">Táº¯t</option>
                <option value="on">Báº­t</option>
            </select>
        </div>
        <div class="control span-4">
            <label>&nbsp;</label>
            <div class="row">
                <button class="btn btn-primary" id="apply">Cáº­p nháº­t danh sÃ¡ch</button>
                <button class="btn btn-ghost" id="resetLearned">XoÃ¡ Ä‘Ã¡nh dáº¥u Ä‘Ã£ thuá»™c</button>
            </div>
        </div>
        <div class="control span-4">
            <label>Thá»‘ng kÃª</label>
            <div class="status" id="stats">â€”</div>
        </div>
    </section>

    <!-- PLAYER / DISPLAY -->
    <section class="player" id="player" aria-disabled="true">
        <div class="display" role="region" aria-live="polite" aria-atomic="true">
            <div class="sentence" id="sentence">Äang chá» dá»¯ liá»‡u tá»« assets/main.jsâ€¦</div>
            <div class="meta" id="meta"></div>
        </div>
        <div class="progress"><div id="bar"></div></div>
        <div class="controls-row">
            <button class="btn btn-primary" id="play" disabled>â–¶ï¸ Báº¯t Ä‘áº§u</button>
            <button class="btn btn-ghost" id="pause" disabled>â¸ï¸ Táº¡m dá»«ng</button>
            <button class="btn btn-ghost" id="prev" disabled>â®ï¸ LÃ¹i</button>
            <button class="btn btn-ghost" id="next" disabled>â­ï¸ Tiáº¿p</button>
            <button class="btn btn-ghost" id="loop">ğŸ” Láº·p: Táº¯t</button>
            <button class="btn btn-ghost" id="mark" disabled>âœ… ÄÃ¡nh dáº¥u Ä‘Ã£ thuá»™c</button>
            <!-- [TTS] ThÃªm hai nÃºt Ä‘iá»u khiá»ƒn phÃ¡t Ã¢m cho tiáº¿ng Nháº­t -->
            <button class="btn btn-ghost" id="ttsToggle" hidden>ğŸ”Š PhÃ¡t Ã¢m: Táº¯t</button>
            <button class="btn btn-ghost" id="ttsSpeak" hidden>ğŸ”ˆ PhÃ¡t cÃ¢u nÃ y</button>
<!--            <span class="hint">PhÃ­m táº¯t: Space (Play/Pause), â†/â†’ (LÃ¹i/Tiáº¿p), L (ÄÃ¡nh dáº¥u)</span>-->
        </div>
    </section>

<!--    <section class="panel" style="margin-top:8px">-->
<!--        <details>-->
<!--            <summary><strong>HÆ°á»›ng dáº«n triá»ƒn khai GitHub Pages</strong></summary>-->
<!--            <ol>-->
<!--                <li>Táº¡o repo má»›i (Public), vÃ­ dá»¥ <code>jp-review</code>.</li>-->
<!--                <li>ThÃªm <code>index.html</code> (file nÃ y) vÃ  thÆ° má»¥c <code>assets</code> chá»©a <code>main.js</code>.</li>-->
<!--                <li>Trong <code>assets/main.js</code>, gÃ¡n <code>window.JP_LESSONS = [ ... ]</code>.</li>-->
<!--                <li>Commit & Push â†’ Settings â†’ Pages â†’ Deploy from a branch â†’ main / /root.</li>-->
<!--                <li>Má»Ÿ URL Pages lÃ  dÃ¹ng Ä‘Æ°á»£c ngay (khÃ´ng cáº§n chá»n file).</li>-->
<!--            </ol>-->
<!--        </details>-->
<!--    </section>-->
</main>

<script>
    // ======= Tráº¡ng thÃ¡i á»©ng dá»¥ng =======
    const state = {
        lessons: [],               // dá»¯ liá»‡u gá»‘c tá»« JP_LESSONS
        pool: [],                  // danh sÃ¡ch cÃ¢u sau khi lá»c
        idx: 0,                    // vá»‹ trÃ­ hiá»‡n táº¡i trong pool
        timer: null,               // setTimeout handle
        isPlaying: false,
        loop: false,
        prefsKey: 'jpReview:prefs:v2', // v2: bá» cÃ¡c prefs liÃªn quan Ä‘áº¿n file
        learnedKey: (lang) => `jpReview:learned:${lang}:v1`,
        // [TTS] Tráº¡ng thÃ¡i phÃ¡t Ã¢m
        ttsEnabled: false,
        ttsReady: false,
        ttsVoice: null,
    };

    // ======= Truy cáº­p DOM =======
    const $ = (sel) => document.querySelector(sel);
    const dataSummary = $('#dataSummary');

    const controlPanel= $('#controlPanel');
    const startDaySel = $('#startDay');
    const endDaySel   = $('#endDay');
    const languageSel = $('#language');
    const modeSel     = $('#mode');
    const speedRange  = $('#speed');
    const speedLabel  = $('#speedLabel');
    const shuffleSel  = $('#shuffle');
    const applyBtn    = $('#apply');
    const resetLearnedBtn = $('#resetLearned');
    const stats       = $('#stats');
    const rangeWarn   = $('#rangeWarn');

    const player      = $('#player');
    const sentenceEl  = $('#sentence');
    const metaEl      = $('#meta');
    const barEl       = $('#bar');
    const playBtn     = $('#play');
    const pauseBtn    = $('#pause');
    const prevBtn     = $('#prev');
    const nextBtn     = $('#next');
    const loopBtn     = $('#loop');
    const markBtn     = $('#mark');
    // [TTS] DOM
    const ttsToggleBtn = $('#ttsToggle');
    const ttsSpeakBtn  = $('#ttsSpeak');

    // ======= Tiá»‡n Ã­ch =======
    function savePrefs() {
        const prefs = {
            language: languageSel.value,
            mode: modeSel.value,
            shuffle: shuffleSel.value,
            speed: Number(speedRange.value),
            startDay: Number(startDaySel.value || 1),
            endDay: Number(endDaySel.value || 1),
            loop: state.loop,
            // [TTS] lÆ°u tráº¡ng thÃ¡i báº­t/táº¯t
            ttsEnabled: state.ttsEnabled,
        };
        localStorage.setItem(state.prefsKey, JSON.stringify(prefs));
    }
    function loadPrefs() {
        try {
            const raw = localStorage.getItem(state.prefsKey);
            if (!raw) return;
            const prefs = JSON.parse(raw);
            if (prefs.language) languageSel.value = prefs.language;
            if (prefs.mode) modeSel.value = prefs.mode;
            if (prefs.shuffle) shuffleSel.value = prefs.shuffle;
            if (prefs.speed) speedRange.value = prefs.speed;
            speedLabel.textContent = speedRange.value;
            if (typeof prefs.loop === 'boolean') state.loop = prefs.loop;
            loopBtn.textContent = `ğŸ” Láº·p: ${state.loop ? 'Báº­t' : 'Táº¯t'}`;
            // start/end day sáº½ set sau khi cÃ³ dá»¯ liá»‡u
            if (prefs.startDay) startDaySel.dataset.pref = prefs.startDay;
            if (prefs.endDay) endDaySel.dataset.pref = prefs.endDay;
            // [TTS]
            if (typeof prefs.ttsEnabled === 'boolean') state.ttsEnabled = prefs.ttsEnabled;
        } catch {}
    }

    function getLearnedSet(lang){
        try{ return new Set(JSON.parse(localStorage.getItem(state.learnedKey(lang))||'[]')); }
        catch{ return new Set(); }
    }
    function saveLearnedSet(lang, set){
        localStorage.setItem(state.learnedKey(lang), JSON.stringify(Array.from(set)));
    }

    function shuffleInPlace(arr){
        for(let i=arr.length-1;i>0;i++){
            const j=Math.floor(Math.random()*(i+1));
            [arr[i],arr[j]]=[arr[j],arr[i]];
        }
        return arr;
    }

    function enableControls(enabled){
        controlPanel.setAttribute('aria-disabled', !enabled);
        player.setAttribute('aria-disabled', !enabled);
        [applyBtn, resetLearnedBtn, startDaySel, endDaySel, languageSel, modeSel, speedRange, shuffleSel, playBtn].forEach(el=>{
            if (!el) return; el.disabled = !enabled;
        });
        // [TTS] chá»‰ báº­t khi Ä‘ang á»Ÿ tiáº¿ng Nháº­t vÃ  cÃ³ API
        updateTtsUI();
    }

    function summarizeData(){
        if(!state.lessons.length){ dataSummary.textContent='ChÆ°a cÃ³ dá»¯ liá»‡u'; return; }
        const days = state.lessons.map(l=>Number(l.day)).filter(n=>!Number.isNaN(n));
        const min = Math.min(...days), max = Math.max(...days);
        let totalJP=0, totalVI=0;
        for(const l of state.lessons){
            totalJP += (l.sections?.japanese?.length || 0);
            totalVI += (l.sections?.vietnamese?.length || 0);
        }
        dataSummary.textContent = `CÃ³ ${state.lessons.length} buá»•i (Day ${min} â†’ ${max}) â€¢ JP: ${totalJP} cÃ¢u â€¢ VI: ${totalVI} cÃ¢u`;
        populateDaySelects(min, max);
    }

    function populateDaySelects(min, max){
        startDaySel.innerHTML = '';
        endDaySel.innerHTML = '';
        for(let d=min; d<=max; d++){
            const o1=document.createElement('option'); o1.value=o1.textContent=d; startDaySel.appendChild(o1);
            const o2=document.createElement('option'); o2.value=o2.textContent=d; endDaySel.appendChild(o2);
        }
        // Ãp prefs náº¿u cÃ³
        const prefStart = Number(startDaySel.dataset.pref || min);
        const prefEnd = Number(endDaySel.dataset.pref || max);
        startDaySel.value = Math.max(min, Math.min(prefStart, max));
        endDaySel.value = Math.max(Number(startDaySel.value), Math.min(prefEnd, max));
        validateRange();
        updateStatsPreview();
    }

    function validateRange(){
        const s = Number(startDaySel.value);
        let e = Number(endDaySel.value);
        if(e < s){ e = s; endDaySel.value = String(e); rangeWarn.hidden = false; }
        else rangeWarn.hidden = true;
    }

    function buildPool(){
        const s = Number(startDaySel.value), e = Number(endDaySel.value);
        const lang = languageSel.value;
        const mode = modeSel.value;
        const learned = getLearnedSet(lang);
        const pool = [];
        for(const lesson of state.lessons){
            const day = Number(lesson.day);
            if (Number.isNaN(day) || day < s || day > e) continue;
            const items = Array.isArray(lesson.sections?.[lang]) ? lesson.sections[lang] : [];
            for(const it of items){
                if(!it || typeof it.text !== 'string' || !it.id) continue;
                if(mode === 'unlearned' && learned.has(it.id)) continue;
                pool.push({ id: it.id, text: it.text, day, lang });
            }
        }
        if (shuffleSel.value === 'on') shuffleInPlace(pool);
        state.pool = pool;
        state.idx = 0;
        updateStatsPreview();
        renderCurrent();
        updateNavButtons();
        savePrefs();
    }

    function updateStatsPreview(){
        if(!state.lessons.length){ stats.textContent='â€”'; return; }
        const s = Number(startDaySel.value||0), e = Number(endDaySel.value||0);
        const lang = languageSel.value;
        const learned = getLearnedSet(lang);
        let total=0, unlearned=0;
        for(const l of state.lessons){
            const day = Number(l.day); if(Number.isNaN(day) || day < s || day > e) continue;
            const arr = Array.isArray(l.sections?.[lang]) ? l.sections[lang] : [];
            for(const it of arr){
                if(!it || !it.id) continue;
                total++;
                if(!learned.has(it.id)) unlearned++;
            }
        }
        stats.textContent = `Khoáº£ng Day ${s} â†’ ${e} â€¢ ${lang==='japanese'?'JP':'VI'}: ${total} cÃ¢u â€¢ ChÆ°a thuá»™c: ${unlearned}`;
    }

    function renderCurrent(){
        const n = state.pool.length;
        if(n === 0){
            sentenceEl.textContent = 'KhÃ´ng cÃ³ cÃ¢u nÃ o trong pháº¡m vi / cháº¿ Ä‘á»™ Ä‘Ã£ chá»n.';
            metaEl.textContent = '';
            barEl.style.width = '0%';
            markBtn.disabled = true; prevBtn.disabled = true; nextBtn.disabled = true;
            return;
        }
        const i = Math.max(0, Math.min(state.idx, n-1));
        state.idx = i;
        const cur = state.pool[i];
        sentenceEl.textContent = cur.text;
        metaEl.textContent = `#${i+1}/${n} â€¢ Day ${cur.day} â€¢ ${cur.lang==='japanese'?'JP':'VI'} â€¢ ID: ${cur.id}`;
        barEl.style.width = `${((i+1)/n)*100}%`;
        // cáº­p nháº­t nÃºt mark theo learned
        const learned = getLearnedSet(cur.lang);
        const isLearned = learned.has(cur.id);
        markBtn.textContent = isLearned ? 'â˜‘ï¸ Bá» Ä‘Ã¡nh dáº¥u' : 'âœ… ÄÃ¡nh dáº¥u Ä‘Ã£ thuá»™c';
        markBtn.disabled = false; prevBtn.disabled = false; nextBtn.disabled = false;

        // [TTS] tá»± Ä‘á»™ng Ä‘á»c khi báº­t vÃ  Ä‘ang á»Ÿ tiáº¿ng Nháº­t
        if(state.ttsEnabled && languageSel.value === 'japanese' && supportsTTS()){
            speakNow(cur.text);
        }
    }

    function updateNavButtons(){
        const disabled = state.pool.length === 0;
        [prevBtn, nextBtn, playBtn, pauseBtn, markBtn].forEach(b=> b.disabled = disabled);
        // [TTS] nÃºt phÃ¡t ngay chá»‰ báº­t khi cÃ³ cÃ¢u vÃ  Ä‘ang á»Ÿ JP
        ttsSpeakBtn.disabled = disabled || languageSel.value !== 'japanese' || !supportsTTS();
    }

    function play(){
        if(state.isPlaying || state.pool.length===0) return;
        state.isPlaying = true;
        playBtn.disabled = true; pauseBtn.disabled = false;
        const tick = () => { if(!state.isPlaying) return; next(); };
        const interval = () => Number(speedRange.value) * 1000;
        function loop(){ if(!state.isPlaying) return; state.timer = setTimeout(()=>{ tick(); loop(); }, interval()); }
        loop();
    }

    function pause(){
        state.isPlaying = false; playBtn.disabled = false; pauseBtn.disabled = true;
        if(state.timer) { clearTimeout(state.timer); state.timer = null; }
        // [TTS]
        cancelTTS();
    }

    function next(){
        if(state.pool.length===0) return;
        // [TTS]
        cancelTTS();
        const atEnd = state.idx >= state.pool.length - 1;
        if(atEnd){ if(state.loop){ state.idx = 0; } else { pause(); return; } }
        else { state.idx++; }
        renderCurrent();
    }
    function prev(){ if(state.pool.length===0) return; cancelTTS(); state.idx = Math.max(0, state.idx - 1); renderCurrent(); }

    function toggleLoop(){ state.loop = !state.loop; loopBtn.textContent = `ğŸ” Láº·p: ${state.loop ? 'Báº­t' : 'Táº¯t'}`; savePrefs(); }

    function toggleLearned(){
        if(state.pool.length===0) return;
        const cur = state.pool[state.idx];
        const set = getLearnedSet(cur.lang);
        const had = set.has(cur.id);
        if(had) set.delete(cur.id); else set.add(cur.id);
        saveLearnedSet(cur.lang, set);
        if(!had && modeSel.value === 'unlearned'){
            state.pool.splice(state.idx, 1);
            if(state.idx >= state.pool.length) state.idx = Math.max(0, state.pool.length-1);
        }
        updateStatsPreview();
        renderCurrent();
    }

    function resetLearned(){
        if(!confirm('XoÃ¡ toÃ n bá»™ Ä‘Ã¡nh dáº¥u Ä‘Ã£ thuá»™c cho cáº£ JP & VI?')) return;
        saveLearnedSet('japanese', new Set());
        saveLearnedSet('vietnamese', new Set());
        updateStatsPreview();
        renderCurrent();
    }

    // ======= [TTS] Há»— trá»£ phÃ¡t Ã¢m =======
    function supportsTTS(){
        return 'speechSynthesis' in window && 'SpeechSynthesisUtterance' in window;
    }
    function ensureTTSVoice(){
        if(!supportsTTS()) return;
        const synth = window.speechSynthesis;
        const pick = () => {
            const voices = synth.getVoices();
            if(!voices || !voices.length) return false;
            // Æ¯u tiÃªn giá»ng ja-JP
            state.ttsVoice = voices.find(v=>/ja(-|_)JP/i.test(v.lang)) || voices.find(v=>/^ja/i.test(v.lang)) || null;
            state.ttsReady = true;
            return true;
        };
        if(!pick()){
            // Má»™t sá»‘ trÃ¬nh duyá»‡t cáº§n láº¯ng nghe sá»± kiá»‡n nÃ y
            synth.onvoiceschanged = () => { pick(); updateTtsUI(); };
        }
    }
    function speakNow(text){
        if(!supportsTTS() || !text) return;
        const u = new SpeechSynthesisUtterance(text);
        u.lang = (state.ttsVoice && state.ttsVoice.lang) || 'ja-JP';
        if(state.ttsVoice) u.voice = state.ttsVoice;
        u.rate = 1.0; // tá»‘c Ä‘á»™ Ä‘á»c
        u.pitch = 1.0;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
    }
    function cancelTTS(){ if(supportsTTS()) window.speechSynthesis.cancel(); }

    function updateTtsUI(){
        const isJP = languageSel.value === 'japanese';
        const can = supportsTTS();
        ttsToggleBtn.hidden = !(isJP && can);
        ttsSpeakBtn.hidden  = !(isJP && can);
        ttsToggleBtn.textContent = `ğŸ”Š PhÃ¡t Ã¢m: ${state.ttsEnabled ? 'Báº­t' : 'Táº¯t'}`;
        ttsSpeakBtn.disabled = !isJP || !can || state.pool.length===0;
    }

    // ======= Náº P Dá»® LIá»†U Tá»ª assets/main.js =======
    async function parseAndSetData(json){
        if(!Array.isArray(json)) throw new Error('JP_LESSONS pháº£i lÃ  máº£ng cÃ¡c buá»•i há»c');
        for(const [i, item] of json.entries()){
            if(typeof item.day === 'undefined') throw new Error(`Pháº§n tá»­ #${i} thiáº¿u trÆ°á»ng day`);
            if(!item.sections) throw new Error(`Pháº§n tá»­ #${i} thiáº¿u sections`);
        }
        state.lessons = json.map(x=>({ day: Number(x.day), topic: x.topic || '', sections: x.sections || {} }));
        summarizeData();
        enableControls(true);
        buildPool();
    }

    // ======= Sá»± kiá»‡n Ä‘iá»u khiá»ƒn =======
    startDaySel.addEventListener('change', ()=>{ validateRange(); updateStatsPreview(); savePrefs(); });
    endDaySel.addEventListener('change', ()=>{ validateRange(); updateStatsPreview(); savePrefs(); });
    languageSel.addEventListener('change', ()=>{ updateStatsPreview(); updateTtsUI(); savePrefs(); if(languageSel.value!=='japanese') cancelTTS(); });
    modeSel.addEventListener('change', ()=>{ updateStatsPreview(); savePrefs(); });
    speedRange.addEventListener('input', ()=>{ speedLabel.textContent = speedRange.value; savePrefs(); });
    shuffleSel.addEventListener('change', savePrefs);

    applyBtn.addEventListener('click', buildPool);
    resetLearnedBtn.addEventListener('click', resetLearned);

    playBtn.addEventListener('click', play);
    pauseBtn.addEventListener('click', pause);
    prevBtn.addEventListener('click', prev);
    nextBtn.addEventListener('click', next);
    loopBtn.addEventListener('click', toggleLoop);
    markBtn.addEventListener('click', toggleLearned);

    // [TTS] sá»± kiá»‡n nÃºt
    ttsToggleBtn.addEventListener('click', ()=>{ state.ttsEnabled = !state.ttsEnabled; ttsToggleBtn.textContent = `ğŸ”Š PhÃ¡t Ã¢m: ${state.ttsEnabled ? 'Báº­t' : 'Táº¯t'}`; savePrefs(); if(!state.ttsEnabled) cancelTTS(); else if(languageSel.value==='japanese') speakNow(sentenceEl.textContent); });
    ttsSpeakBtn.addEventListener('click', ()=>{ if(languageSel.value==='japanese') speakNow(sentenceEl.textContent); });

    // PhÃ­m táº¯t
    document.addEventListener('keydown', (e)=>{
        if(e.target && (e.target.tagName==='INPUT' || e.target.tagName==='SELECT' || e.target.isContentEditable)) return;
        if(e.code === 'Space'){ e.preventDefault(); state.isPlaying ? pause() : play(); }
        else if(e.code === 'ArrowRight'){ next(); }
        else if(e.code === 'ArrowLeft'){ prev(); }
        else if(e.key.toLowerCase() === 'l'){ toggleLearned(); }
    });

    // ======= Khá»Ÿi táº¡o =======
    (function init(){
        loadPrefs();
        ensureTTSVoice(); // [TTS] chuáº©n bá»‹ giá»ng Ä‘á»c
        // Äá»£i script assets/main.js khai bÃ¡o window.JP_LESSONS
        window.addEventListener('DOMContentLoaded', ()=>{
            const data = window.JP_LESSONS;
            if(Array.isArray(data)){
                parseAndSetData(data).catch(err=>{
                    sentenceEl.textContent = 'Lá»—i dá»¯ liá»‡u: ' + err.message;
                });
            } else {
                sentenceEl.textContent = 'ChÆ°a tÃ¬m tháº¥y dá»¯ liá»‡u. HÃ£y táº¡o assets/main.js vÃ  gÃ¡n window.JP_LESSONS = [...].';
                enableControls(false);
            }
            updateTtsUI();
        });
    })();
</script>
</body>
</html>
